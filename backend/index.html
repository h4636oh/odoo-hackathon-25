<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased">
    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="mb-8 flex justify-between items-center">
            <h1 class="text-3xl font-bold text-gray-800">Expense Tracker</h1>
            <button id="logoutButton" class="hidden bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                Logout
            </button>
        </header>

        <!-- Auth Section -->
        <div id="authSection">
            <div class="grid md:grid-cols-2 gap-8">
                <!-- Login Form -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Login</h2>
                    <form id="loginForm">
                        <div class="mb-4">
                            <label for="loginEmail" class="block text-gray-700 text-sm font-bold mb-2">Email (Username)</label>
                            <input type="email" id="loginEmail" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <div class="mb-6">
                            <label for="loginPassword" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                            <input type="password" id="loginPassword" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300">
                            Sign In
                        </button>
                    </form>
                </div>
                <!-- Admin Signup Form -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Admin Signup</h2>
                    <form id="signupForm">
                        <div class="mb-4">
                            <label for="signupEmail" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                            <input type="email" id="signupEmail" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                        <div class="mb-4">
                            <label for="signupPassword" class="block text-gray-700 text-sm font-bold mb-2">Password</label>
                            <input type="password" id="signupPassword" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                         <div class="mb-4">
                            <label for="signupCompany" class="block text-gray-700 text-sm font-bold mb-2">Company Name</label>
                            <input type="text" id="signupCompany" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                        <div class="mb-4">
                            <label for="signupCountry" class="block text-gray-700 text-sm font-bold mb-2">Country</label>
                            <input type="text" id="signupCountry" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                        <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition duration-300">
                            Create Admin Account
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" class="hidden">
            <p class="mb-6 text-lg">Welcome! You are logged in. Your token is stored in localStorage.</p>
             <div class="grid md:grid-cols-2 gap-8">
                <!-- Admin: Create User -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                     <h2 class="text-2xl font-semibold mb-4 text-gray-700">Admin: Create User</h2>
                     <form id="createUserForm">
                         <div class="mb-4">
                             <label for="userName" class="block text-gray-700 text-sm font-bold mb-2">Name</label>
                             <input type="text" id="userName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                         </div>
                         <div class="mb-4">
                            <label for="userEmail" class="block text-gray-700 text-sm font-bold mb-2">Email</label>
                            <input type="email" id="userEmail" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required>
                        </div>
                         <div class="mb-4">
                            <label for="userRole" class="block text-gray-700 text-sm font-bold mb-2">Role</label>
                            <select id="userRole" class="shadow border rounded w-full py-2 px-3 text-gray-700">
                                <option>employee</option>
                                <option>manager</option>
                            </select>
                         </div>
                         <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded transition duration-300">Create User</button>
                     </form>
                 </div>
                 <!-- User: Create Expense -->
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-700">Employee: Create Expense Request</h2>
                     <form id="createExpenseForm">
                         <div class="mb-2">
                             <label for="expenseDesc" class="block text-gray-700 text-sm font-bold mb-1">Description</label>
                             <input type="text" id="expenseDesc" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required value="Lunch Meeting">
                         </div>
                         <div class="mb-2">
                            <label for="expenseAmount" class="block text-gray-700 text-sm font-bold mb-1">Amount</label>
                            <input type="number" id="expenseAmount" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required value="50.75">
                        </div>
                         <div class="mb-2">
                             <label for="expenseCurrency" class="block text-gray-700 text-sm font-bold mb-1">Currency</label>
                             <input type="text" id="expenseCurrency" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700" required value="USD">
                         </div>
                         <button type="submit" class="w-full mt-4 bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded transition duration-300">Submit Expense</button>
                     </form>
                 </div>
             </div>
             <!-- Data Display -->
             <div id="dataDisplay" class="mt-8 bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-semibold mb-4 text-gray-700">Data from API</h2>
                 <button id="fetchUsersButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded mb-4">Fetch All Users (Admin)</button>
                 <pre id="apiResponse" class="bg-gray-200 p-4 rounded-md overflow-x-auto"></pre>
             </div>
        </div>

         <!-- Message Area -->
        <div id="messageArea" class="mt-6 p-4 rounded-md text-center font-semibold"></div>
    </div>

<script>
    // --- IMPORTANT ---
    // PASTE YOUR NGROK FORWARDING URL HERE
    const API_BASE_URL = "https://your-ngrok-url.ngrok-free.app"; 
    // Example: "https://9a2f-103-10-31-4.ngrok-free.app"

    // DOM Elements
    const authSection = document.getElementById('authSection');
    const dashboardSection = document.getElementById('dashboardSection');
    const logoutButton = document.getElementById('logoutButton');
    const messageArea = document.getElementById('messageArea');

    // Forms
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const createUserForm = document.getElementById('createUserForm');
    const createExpenseForm = document.getElementById('createExpenseForm');
    
    // Buttons
    const fetchUsersButton = document.getElementById('fetchUsersButton');
    
    // Data Display
    const apiResponse = document.getElementById('apiResponse');

    // --- UTILITY FUNCTIONS ---

    function showMessage(message, isError = false) {
        messageArea.textContent = message;
        messageArea.className = `mt-6 p-4 rounded-md text-center font-semibold ${isError ? 'bg-red-200 text-red-800' : 'bg-green-200 text-green-800'}`;
        setTimeout(() => messageArea.textContent = '', 5000);
    }

    function updateUI() {
        const token = localStorage.getItem('accessToken');
        if (token) {
            authSection.classList.add('hidden');
            dashboardSection.classList.remove('hidden');
            logoutButton.classList.remove('hidden');
        } else {
            authSection.classList.remove('hidden');
            dashboardSection.classList.add('hidden');
            logoutButton.classList.add('hidden');
        }
    }

    // --- API CALLS ---

    async function handleLogin(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;

        // FastAPI's OAuth2PasswordRequestForm expects form data, not JSON
        const formData = new FormData();
        formData.append('username', email);
        formData.append('password', password);

        try {
            // We use the universal /token endpoint which can log in admins and users
            const response = await fetch(`${API_BASE_URL}/token`, {
                method: 'POST',
                body: formData,
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.detail || 'Login failed');
            }
            localStorage.setItem('accessToken', data.access_token);
            showMessage('Login successful!');
            updateUI();
        } catch (error) {
            showMessage(`Login Error: ${error.message}`, true);
        }
    }

    async function handleSignup(e) {
        e.preventDefault();
        const payload = {
            email: document.getElementById('signupEmail').value,
            password: document.getElementById('signupPassword').value,
            company_name: document.getElementById('signupCompany').value,
            country: document.getElementById('signupCountry').value,
        };

        try {
            const response = await fetch(`${API_BASE_URL}/admin/signup`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload),
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.detail || 'Signup failed');
            }
            localStorage.setItem('accessToken', data.access_token);
            showMessage('Admin account created successfully!');
            updateUI();
        } catch (error) {
            showMessage(`Signup Error: ${error.message}`, true);
        }
    }
    
    function handleLogout() {
        localStorage.removeItem('accessToken');
        showMessage('You have been logged out.');
        apiResponse.textContent = '';
        updateUI();
    }

    async function handleCreateUser(e) {
        e.preventDefault();
        const payload = {
            name: document.getElementById('userName').value,
            email: document.getElementById('userEmail').value,
            role: document.getElementById('userRole').value,
        };
        
        try {
            const response = await fetch(`${API_BASE_URL}/admin/create_user`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to create user');
            }
            showMessage(data.message || 'User created successfully!');
            createUserForm.reset();
        } catch (error) {
            showMessage(`Error creating user: ${error.message}`, true);
        }
    }

    async function handleCreateExpense(e) {
        e.preventDefault();
        const payload = {
            requestor: "self", // Backend will override this based on token
            description: document.getElementById('expenseDesc').value,
            expense_date: new Date().toISOString().split('T')[0],
            category: "General",
            paidBy: "self", // Backend will override this
            payment_Currency: document.getElementById('expenseCurrency').value,
            payment_Amount: parseFloat(document.getElementById('expenseAmount').value),
            remarks: "Submitted from frontend"
        };

        try {
             const response = await fetch(`${API__URL}/user/create_request`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.detail || 'Failed to create expense');
            }
            showMessage(data.message || 'Expense request created!');
            createExpenseForm.reset();
        } catch (error) {
            showMessage(`Error creating expense: ${error.message}`, true);
        }
    }

    async function handleFetchUsers() {
        try {
             const response = await fetch(`${API_BASE_URL}/admin/users`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('accessToken')}`
                }
            });
            const data = await response.json();
             if (!response.ok) {
                throw new Error(data.detail || 'Failed to fetch users');
            }
            apiResponse.textContent = JSON.stringify(data, null, 2);

        } catch (error) {
            showMessage(`Error fetching users: ${error.message}`, true);
            apiResponse.textContent = `Error: ${error.message}`;
        }
    }

    // --- EVENT LISTENERS ---
    
    loginForm.addEventListener('submit', handleLogin);
    signupForm.addEventListener('submit', handleSignup);
    logoutButton.addEventListener('click', handleLogout);
    createUserForm.addEventListener('submit', handleCreateUser);
    createExpenseForm.addEventListener('submit', handleCreateExpense);
    fetchUsersButton.addEventListener('click', handleFetchUsers);

    // --- INITIALIZATION ---

    // Check login status on page load
    document.addEventListener('DOMContentLoaded', () => {
        if (!API_BASE_URL.startsWith('https')) {
            alert('Please update the API_BASE_URL in index.html with your ngrok URL.');
        }
        updateUI();
    });

</script>
</body>
</html>
